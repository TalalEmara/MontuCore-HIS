// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum Role {
  ADMIN
  CLINICIAN
  ATHLETE
}

enum Severity {
  MILD
  MODERATE
  SEVERE
  CRITICAL
}

enum ApptStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
}

enum CaseStatus {
  ACTIVE
  RECOVERED
}

enum ExamStatus {
  ORDERED
  COMPLETED
  CANCELLED
}

// Generic status for Exams/Labs if needed, or specific ones
enum LabStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  PENDING
  PAID
  CANCELLED
}

// --- EXTERNAL COLLABORATION ---

model ConsultationShare {
  id            Int      @id @default(autoincrement())
  token         String   @unique @default(uuid()) // The secret link
  accessCode    String   @map("access_code") // Access code for viewing
  
  // 1. THE ACTOR (Must be a Clinician)
  clinicianId   Int      @map("clinician_id")
  clinician     User     @relation("CreatedShares", fields: [clinicianId], references: [id])

  // 2. THE SUBJECT (The Patient)
  athleteId     Int      @map("athlete_id")
  athlete       User     @relation("PatientShares", fields: [athleteId], references: [id])

  // 3. THE DATA (JSON Allow-list)
  permissions   Json     @map("permissions") // e.g. { "caseIds": [1] }

  expiresAt     DateTime @map("expires_at")
  createdAt     DateTime @default(now()) @map("created_at")
  accessedAt    DateTime? @map("accessed_at")

  @@map("consultation_shares")
}

// Update the User model to match these specific relation names
// --- USERS & AUTH ---

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String    @map("password_hash")
  fullName     String    @map("full_name")
  dateOfBirth  DateTime? @map("date_of_birth")
  phoneNumber  String?   @map("phone_number")
  gender       String? // 'Male', 'Female'
  role         Role      @default(ATHLETE)
  createdAt    DateTime  @default(now())

  // Relations
  createdShares ConsultationShare[] @relation("CreatedShares") // Only populated if role=CLINICIAN
  patientShares ConsultationShare[] @relation("PatientShares") // Only populated if role=ATHLETE

  // Profiles
  athleteProfile   AthleteProfile?
  clinicianProfile ClinicianProfile?

  // As Athlete
  athleteAppointments Appointment[] @relation("AthleteAppt")
  athleteCases        Case[]        @relation("AthleteCase")

  // As Clinician
  clinicianAppointments Appointment[] @relation("ClinicianAppt")
  managedCases          Case[]        @relation("ManagingClinician")

  // Invoice
  athleteInvoices   Invoice[] @relation("InvoiceAthlete")
  clinicianInvoices Invoice[] @relation("InvoiceClinician")

  @@map("users")
}

// --- PROFILES ---

model AthleteProfile {
  id           Int     @id @default(autoincrement())
  userId       Int     @unique @map("user_id")
  user         User    @relation(fields: [userId], references: [id])
  position     String?
  jerseyNumber Int?    @map("jersey_number")

  @@map("athlete_profiles")
}

model ClinicianProfile {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique @map("user_id")
  user      User    @relation(fields: [userId], references: [id])
  specialty String? // 'Physio', 'Ortho', 'Nutritionist'

  @@map("clinician_profiles")
}

// --- CORE MEDICAL DATA ---

model Appointment {
  id          Int  @id @default(autoincrement())
  athleteId   Int  @map("athlete_id")
  clinicianId Int  @map("clinician_id")
  caseId      Int? @map("case_id") // Link to the case this appointment belongs to

  // Relations
  athlete              User       @relation("AthleteAppt", fields: [athleteId], references: [id])
  clinician            User       @relation("ClinicianAppt", fields: [clinicianId], references: [id])
  initialCaseDetection Case?      @relation("InitialCaseAppointment") // The case where this was the initial appointment (one-to-one)
  invoices             Invoice[]  @relation("InvoiceAppointment")
  scheduledAt          DateTime   @map("scheduled_at")
  height               Float?
  weight               Float?
  status               ApptStatus @default(SCHEDULED)
  diagnosisNotes       String?    @map("diagnosis_notes") // Initial notes

  @@map("appointments")
}

model Case {
  id                   Int @id @default(autoincrement())
  athleteId            Int @map("athlete_id")
  managingClinicianId  Int @map("managing_clinician_id")
  initialAppointmentId Int @unique @map("initial_appointment_id") // The appointment where case was first detected (one-to-one)

  // Relations
  athlete            User        @relation("AthleteCase", fields: [athleteId], references: [id])
  managingClinician  User        @relation("ManagingClinician", fields: [managingClinicianId], references: [id])
  initialAppointment Appointment @relation("InitialCaseAppointment", fields: [initialAppointmentId], references: [id])
  invoices           Invoice[]   @relation("InvoiceCase")
  diagnosisName      String      @map("diagnosis_name") // "ACL Tear", "Concussion"
  icd10Code          String?     @map("icd10_code")
  injuryDate         DateTime    @default(now()) @map("injury_date")
  status             CaseStatus  @default(ACTIVE)
  severity           Severity    @default(MILD)
  medicalGrade       String?     @map("medical_grade") // "Grade 2", "Stage 1"

  // Sub-Tables
  exams          Exam[]
  labTests       LabTest[]
  treatments     Treatment[]
  physioPrograms PhysioProgram[]

  @@map("cases")
}

// --- PACS & IMAGING SYSTEM ---

// 1. The Metadata (The Order)
model Exam {
  id          Int  @id @default(autoincrement())
  caseId      Int  @map("case_id")
  medicalCase Case @relation(fields: [caseId], references: [id])

  modality String // 'MRI', 'CT', 'X-RAY'
  bodyPart String @map("body_part") // 'Knee', 'Shoulder'
  status   ExamStatus // 'ORDERED', 'COMPLETED', 'CANCELLED'

  scheduledAt DateTime? @map("scheduled_at")
  performedAt DateTime? @map("performed_at")

  radiologistNotes String? @map("radiologist_notes")
  conclusion       String?
  cost             Float?

  // DICOM Images (multiple per exam)
  pacsImages PACSImage[]

  @@map("exams")
}

// 2. The DICOM Images (Multiple per Exam)
model PACSImage {
  id          Int  @id @default(autoincrement())
  examId      Int  @map("exam_id")
  exam        Exam @relation(fields: [examId], references: [id])

  fileName       String
  supabasePath   String    @map("supabase_path")
  publicUrl      String    @map("public_url")
  uploadedAt     DateTime  @default(now()) @map("uploaded_at")

  @@map("pacs_images")
}

// --- LAB SYSTEM (Blood Tests) ---

model LabTest {
  id     Int @id @default(autoincrement())
  caseId Int @map("case_id")

  testName String    @map("test_name") // 'CBC', 'Lipid Profile'
  category String? // 'Hematology'
  status   LabStatus @default(PENDING)

  // Results
  resultPdfUrl       String? @map("result_pdf_url") // For the PDF Report
  resultValues       Json?   @map("result_values") // For specific values like {"RBC": 5.0}
  labTechnicianNotes String? @map("lab_technician_notes")

  sampleDate DateTime? @map("sample_date")
  cost       Float?

  // Relations
  medicalCase Case @relation(fields: [caseId], references: [id])

  @@map("lab_tests")
}

// --- TREATMENTS & PHYSIO ---

model Treatment {
  id     Int @id @default(autoincrement())
  caseId Int @map("case_id")

  type         String // 'Surgery', 'Medication'
  description  String
  providerName String?  @map("provider_name") // 'External Hospital'
  cost         Float?
  date         DateTime @default(now())

  // Relations
  medicalCase Case @relation(fields: [caseId], references: [id])

  @@map("treatments")
}

model PhysioProgram {
  id     Int @id @default(autoincrement())
  caseId Int @map("case_id")

  title             String
  numberOfSessions  Int      @map("number_of_sessions")
  sessionsCompleted Int      @default(0) @map("sessions_completed")
  startDate         DateTime @map("start_date")
  weeklyRepetition  Int      @map("weekly_repetition")
  costPerSession    Float?   @map("cost_per_session")
  // Relations
  medicalCase       Case     @relation(fields: [caseId], references: [id])

  @@map("physio_programs")
}

// --- BILLING ---

model Invoice {
  id            Int      @id @default(autoincrement())
  athleteId     Int
  clinicianId   Int
  caseId        Int?
  appointmentId Int?
  invoiceNumber String   @unique
  invoiceDate   DateTime
  dueDate       DateTime
  items         Json
  subtotal      Float
  totalAmount   Float
  status        String
  paidAmount    Float    @default(0)
  notes         String?
  createdBy     Int
  createdAt     DateTime @default(now())

  // Relations with unique names
  athlete     User         @relation("InvoiceAthlete", fields: [athleteId], references: [id])
  clinician   User         @relation("InvoiceClinician", fields: [clinicianId], references: [id])
  case        Case?        @relation("InvoiceCase", fields: [caseId], references: [id])
  appointment Appointment? @relation("InvoiceAppointment", fields: [appointmentId], references: [id])

  @@map("invoices")
}


model RevokedToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  revokedAt DateTime @default(now()) @map("revoked_at")
  expiresAt DateTime @map("expires_at") // When the token would have expired anyway

  @@map("revoked_tokens")
}